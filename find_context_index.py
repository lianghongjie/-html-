# -*- encoding: utf-8 -*-

from scrapely.htmlpage import HtmlPage, HtmlTag
import re
from util.encode_tools import code_to_unicode
from errors import ContextNoMatch, MultipleContextMatch


def find_context_index(htmlpage, text_compile):
    matches = []
    text_compile = code_to_unicode(text_compile)
    for index, fragment in enumerate(htmlpage.parsed_body):
        fdata = htmlpage.fragment_data(fragment).strip()

        match = re.search(text_compile, fdata)
        if not match:
            continue
        matches.append(index)
    if matches.__len__() == 1: return matches[0]
    elif matches.__len__() > 1:
        raise MultipleContextMatch
    else:
        raise ContextNoMatch


def full_div_context_index(htmlpage, text_compile, diff=None, ele_type='div'):
    """
    diff 偏移量, ele_type 查找的元素类型
    可自动去除成对的ele_type类型标签
    :param htmlpage:
    :param text_compile:
    :param diff int:
    :param ele_type str:
    :return:
    """
    ele_index = find_context_index(htmlpage, text_compile)
    close_tag_type_count = 0
    for index, franment in enumerate(reversed(htmlpage.parsed_body[: ele_index+1])):
        if isinstance(franment, HtmlTag) and franment.tag == ele_type:
            if franment.tag_type == 2:
                close_tag_type_count += 1
                continue
            else:
                if close_tag_type_count:
                    close_tag_type_count -= 1
                    continue
                if not diff:
                    div_index = ele_index - index
                    return div_index
                diff -= 1


if __name__ == '__main__':
    import requests
    # url = 'http://finance.ifeng.com/a/20180416/16098030_0.shtml'
    url = 'http://www.aastocks.com/tc/stocks/news/aafn-news/NOW.868068/2'
    # url = 'http://www.gdtv.cn/politics/folder619/2018-04-17/1388551.html'
    headers = {
        "Cookie":
            "prov=cn010; city=010; weather_city=bj; region_ip=111.198.24.x; region_ver=1.2; userid=1523330065384_jblxca8959; UM_distinctid=162ad8c84f82db-0f9eb56a201821-3a76015a-1aeaa0-162ad8c84f9458; vjuids=-3b54fe109.162ae2213fe.0.4e31c99192779; __gads=ID=6f3d8bbf0d575a34:T=1523341269:S=ALNI_MZdIo4VoemQcJz5_XPE5uscNTOCbQ; games_source_375765101=4; games_source_316765743=3; vjlast=1523339892.1523439244.13; BAIDU_SSP_lcr=https://www.baidu.com/link?url=A-NqNkDB9c0Ztb2sjKmjNM87AuusZF-KsdhrP1x1qCVMz6K5C4dy_wWtoV0K6LD9&wd=&eqid=bb70142b000121e9000000025acf06d9; ifengRotator_AP299=0; bdshare_firstime=1523517357361; CNZZDATA1269613747=1575582443-1523513688-null%7C1523859342; ifengRotator_iis3=5; CNZZDATA1257375399=261690128-1523514973-http%253A%252F%252Fculture.ifeng.com%252F%7C1523860573; CNZZDATA1266101310=70189921-1523515450-http%253A%252F%252Fculture.ifeng.com%252F%7C1523861051; games_source_3962747416=10; ifengRotator_iis3_c=16; CNZZDATA1257652052=272132132-1523516671-http%253A%252F%252Fculture.ifeng.com%252F%7C1523862291; ifengRotator_AP2842=1",
        'User-Agent': 'Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/64.0.3282.186 Safari/537.36'
    }
    # body = requests.get(url=url, headers=headers).content.decode('utf-8')
    body = u"""<div id="newscontent_wrapper"> <div style="clear:both;"> <span id="spanContent" class="newscontent5 fLevel3"> <div class="float_l" style="padding:2px 15px 10px 0"><div style="position:relative"><img class="enlarge" style="width: 396px; height: 222px; cursor: pointer;" src="http://plib.aastocks.com/aafnnews/image/medialib/20180320103539160_m.jpg"><div class="btnEnlargeOpen" style="z-index: 99999;"></div></div></div> <p>港匯持續疲弱，金管局下午第七度入市買入33.76億港元。港股今日反覆下跌。美國商務部宣布禁止美國企業，向內地電信設備廠商中興通訊(00763.HK)<span class="jssc inline_block ">&nbsp;</span><a href="javascript:gotobmp('00763')" class="jsStock jsBmpStock" sym="00763"><span class="quote-box2 unc cls">&nbsp;0.000 (0.000%)&nbsp;&nbsp;</span> </a>出售零部件產品為期七年，市場關注相關制裁或影響中美貿易戰氣氛、對全球通訊、手機設備及晶片製造行業的產業鏈所造成影響；執筆之時美匯指數處89.366。亞股走個別，日經指數微升12點；內地首季GDP按年增6.8%符預期、3月規模以上工業增加值按年升6%(市場原預期升6.3%)，上證綜指跌1.4%收3,066，滬深兩市成交額共4,664億人民幣。<br><br>恆指今早高開39點後反覆上落，午後最多挫逾300點，最終恆指全日跌252點或0.8%，收30,062，連跌四日(累跌834點或2.7%)；國指全日跌107點或0.9%，收11,900點，連跌四日(累跌424點或3.4%)。大市成交額1,171.9億元。滬港通南下交易淨流出金額為7.07億人民幣，及深港通南下交易淨流入金額為3,930萬人民幣。騰訊(00700.HK)<span class="jssc inline_block ">&nbsp;</span><a href="javascript:gotobmp('00700')" class="jsStock jsBmpStock" sym="00700"><span class="quote-box2 neg cls">&nbsp;-5.800 (-1.439%)&nbsp;&nbsp;</span> </a><a href="javascript:gotoss('00700')" class="jsSS"><span class="ss-box cls">&nbsp;沽空&nbsp;$15.49億;&nbsp;比率&nbsp;13.619%&nbsp;&nbsp;</span> </a>股價失守400元，全日走低1.4%收397.2元。<br><br>【恆指四連跌 手機股捱沽】<br><br>中興通訊(00763.HK)<span class="jssc inline_block ">&nbsp;</span><a href="javascript:gotobmp('00763')" class="jsStock jsBmpStock" sym="00763"><span class="quote-box2 unc cls">&nbsp;0.000 (0.000%)&nbsp;&nbsp;</span> </a>今早停牌，遭美國政府禁止其向美國企業購買敏感產品，公司指正在全面評估此事件對公司可能產生的影響，與各方面積極溝通及應對。手機設備股受壓，瑞聲(02018.HK)<span class="jssc inline_block ">&nbsp;</span><a href="javascript:gotobmp('02018')" class="jsStock jsBmpStock" sym="02018"><span class="quote-box2 neg cls">&nbsp;-6.400 (-4.552%)&nbsp;&nbsp;</span> </a><a href="javascript:gotoss('02018')" class="jsSS"><span class="ss-box cls">&nbsp;沽空&nbsp;$2.10億;&nbsp;比率&nbsp;19.190%&nbsp;&nbsp;</span> </a>及舜宇(02382.HK)<span class="jssc inline_block ">&nbsp;</span><a href="javascript:gotobmp('02382')" class="jsStock jsBmpStock" sym="02382"><span class="quote-box2 neg cls">&nbsp;-9.000 (-5.769%)&nbsp;&nbsp;</span> </a><a href="javascript:gotoss('02382')" class="jsSS"><span class="ss-box cls">&nbsp;沽空&nbsp;$3.16億;&nbsp;比率&nbsp;21.856%&nbsp;&nbsp;</span> </a>分別跌4.6%及5.8%，丘鈦科技(01478.HK)<span class="jssc inline_block ">&nbsp;</span><a href="javascript:gotobmp('01478')" class="jsStock jsBmpStock" sym="01478"><span class="quote-box2 neg cls">&nbsp;-0.480 (-4.301%)&nbsp;&nbsp;</span> </a><a href="javascript:gotoss('01478')" class="jsSS"><span class="ss-box cls">&nbsp;沽空&nbsp;$6.95百萬;&nbsp;比率&nbsp;9.176%&nbsp;&nbsp;</span> </a>走低4.3%；高偉(01415.HK)<span class="jssc inline_block ">&nbsp;</span><a href="javascript:gotobmp('01415')" class="jsStock jsBmpStock" sym="01415"><span class="quote-box2 neg cls">&nbsp;-0.070 (-3.553%)&nbsp;&nbsp;</span> </a><a href="javascript:gotoss('01415')" class="jsSS"><span class="ss-box cls">&nbsp;沽空&nbsp;$32.67萬;&nbsp;比率&nbsp;1.796%&nbsp;&nbsp;</span> </a>跌3.6%、比亞迪電子(00285.HK)<span class="jssc inline_block ">&nbsp;</span><a href="javascript:gotobmp('00285')" class="jsStock jsBmpStock" sym="00285"><span class="quote-box2 neg cls">&nbsp;-0.840 (-6.364%)&nbsp;&nbsp;</span> </a><a href="javascript:gotoss('00285')" class="jsSS"><span class="ss-box cls">&nbsp;沽空&nbsp;$1.50千萬;&nbsp;比率&nbsp;16.088%&nbsp;&nbsp;</span> </a>下滑6.4%。晶片股造淡，中芯(00981.HK)<span class="jssc inline_block ">&nbsp;</span><a href="javascript:gotobmp('00981')" class="jsStock jsBmpStock" sym="00981"><span class="quote-box2 neg cls">&nbsp;-0.300 (-3.064%)&nbsp;&nbsp;</span> </a><a href="javascript:gotoss('00981')" class="jsSS"><span class="ss-box cls">&nbsp;沽空&nbsp;$5.54千萬;&nbsp;比率&nbsp;13.062%&nbsp;&nbsp;</span> </a>股價走低3%。<br><br>瑞信報告指，海外對中興政策收緊及有關監管，將為其短期帶來不明朗及挑戰。不過，另一方面，集團在海外市場贏得新項目，及內地電訊商新的資本開支計劃，可為其正面催化劑。瑞信維持對中興H股「中性」評級，基於明年預測市盈率17.5倍估算，目標價28.1元。中金指，中興現時有一至兩個月零部件存貨，若集團不在一至兩個月內再次達成和解，會影響通信設備和手機等業務的正常生產與銷售。該行稱，是次事件令人非常意外，是中美貿易摩擦的一部分。可能需要商務部等政府相關部門出面通過外交途徑加以解決。同時，中金注意到美國一些高科技公司也面臨中國政府的壓力。<br><br>【跌股一千隻 汽車股偏軟】<br><br>港股主板市寬續弱，主板股票的升跌比率為15比34(上日為12比38)，下跌股份1,078隻(跌幅2.2%)；恆指成份股今日8隻股份上升，下跌股份40隻。大市今日錄沽空138.5億元，佔可沽空股份成交897.34億元的15.434%(上日16.981%)。<br><br>內地首季GDP按年增6.8%符預期，高盛發表報告表示，內地首季GDP表現符合預期，指3月工業增加值及固定資產投資低於預期，指3月零售銷售較今年首兩月回升，該行決定上調對中國2018年實質GDP增長預測，由6.5%升至6.6%。<br><br>部份中資汽車股造淡，吉利(00175.HK)<span class="jssc inline_block ">&nbsp;</span><a href="javascript:gotobmp('00175')" class="jsStock jsBmpStock" sym="00175"><span class="quote-box2 neg cls">&nbsp;-0.550 (-2.397%)&nbsp;&nbsp;</span> </a><a href="javascript:gotoss('00175')" class="jsSS"><span class="ss-box cls">&nbsp;沽空&nbsp;$7.60千萬;&nbsp;比率&nbsp;8.139%&nbsp;&nbsp;</span> </a>及廣汽(02238.HK)<span class="jssc inline_block ">&nbsp;</span><a href="javascript:gotobmp('02238')" class="jsStock jsBmpStock" sym="02238"><span class="quote-box2 neg cls">&nbsp;-0.280 (-1.902%)&nbsp;&nbsp;</span> </a><a href="javascript:gotoss('02238')" class="jsSS"><span class="ss-box cls">&nbsp;沽空&nbsp;$8.08百萬;&nbsp;比率&nbsp;4.053%&nbsp;&nbsp;</span> </a>股價各下滑2.4%及1.9%，華晨中國(01114.HK)<span class="jssc inline_block ">&nbsp;</span><a href="javascript:gotobmp('01114')" class="jsStock jsBmpStock" sym="01114"><span class="quote-box2 neg cls">&nbsp;-0.600 (-4.043%)&nbsp;&nbsp;</span> </a><a href="javascript:gotoss('01114')" class="jsSS"><span class="ss-box cls">&nbsp;沽空&nbsp;$1.00億;&nbsp;比率&nbsp;18.062%&nbsp;&nbsp;</span> </a>跌4%收14.24元。發改委在記者會上表示，目前製造業已基本開放，下一步擴大開放的方向很明確，就是要實現全面開放。新的外商投資負面清單將把製造業開放作為一項重點。比如，汽車行業將分類型實行過渡期開放，2018年取消專用車、新能源汽車外資股比限制；2020年取消商用車外資股比限制；2022年取消乘用車外資股比限制，同時取消合資企業不超過2家的限制。通過5年過渡期，汽車行業將全部取消限制。(wl/a)(報價延遲最少十五分鐘。沽空資料截至 2018-04-17 16:25。)</p><div class="urlfooter"><div class="aafb_link"> <a target="_blank" href="https://www.facebook.com/AAStocks.com.Limited"><div class="aafb_link_icon inline_block"></div></a> </div>阿思達克財經新聞<br>網址: www.aastocks.com									<br> <p></p></div> </span> <div id="pStocksMiniChart" style="width: 320px; position: absolute; top: 0px; right: 0px; display: none; z-index: 999999;"><div id="miniChartCore"><div style="width:300px; padding:0 10px;"><div class="quotecore" style=""></div><div></div></div></div></div> <div style="position:relative; clear:both; width:100%; height:0px;"> <div style="position:absolute; bottom:1px; right:1px;"> <div id="pShareContent"> <div id="divShareText">分享</div> <div id="divShareButtons" class="status1" style="background-color: rgb(255, 255, 255);"> <div id="divShareDirection" class="float_l"><div></div></div> <div id="divShareButtonsWrapper" class="float_l"> <div style="position:absolute; top:0px; right:0px; width:300px; height:38px;"> <div class="float_r news-icon-map news-icon-mail pt" style="margin:2px 12px 0px 0px;" onclick="javascript:emailNews()"></div> <div class="float_r news-icon-map news-icon-wechat pt" style="margin:2px 16px 0px 0px;" id="btnWeChat" wechat-share="http://www.aastocks.com/tc/stocks/news/aafn-news/NOW.868068/2"></div> <div class="float_r news-icon-map news-icon-twitter pt" style="margin:2px 16px 0px 0px;" onclick="javascript:twitterClick('http://twitter.com/home?status=%e3%80%8a%e5%8d%b3%e6%97%a5%e5%b8%82%e8%a9%95%e3%80%8b%e4%b8%ad%e7%be%8e%e8%b2%bf%e6%98%93%e6%88%b0%e5%8d%87%e6%ba%ab%e6%81%86%e6%8c%87%e5%86%8d%e8%b7%8c+%e6%89%8b%e6%a9%9f%e8%a8%ad%e5%82%99%e8%82%a1%e6%8d%b1%e6%b2%bd+%7c+%e9%98%bf%e6%80%9d%e9%81%94%e5%85%8b%e8%b2%a1%e7%b6%93%e7%b6%b2+http%3a%2f%2fwww.aastocks.com%2ftc%2fstocks%2fnews%2faafn-news%2fNOW.868068%2f2')"></div> <div class="float_r news-icon-map news-icon-weibo pt" style="margin:2px 16px 0px 0px;" onclick="javascript:weiboClick('http://service.weibo.com/share/share.php?url=&amp;title=%e3%80%8a%e5%8d%b3%e6%97%a5%e5%b8%82%e8%a9%95%e3%80%8b%e4%b8%ad%e7%be%8e%e8%b2%bf%e6%98%93%e6%88%b0%e5%8d%87%e6%ba%ab%e6%81%86%e6%8c%87%e5%86%8d%e8%b7%8c+%e6%89%8b%e6%a9%9f%e8%a8%ad%e5%82%99%e8%82%a1%e6%8d%b1%e6%b2%bd%0d%0a%0d%0a%e6%b8%af%e5%8c%af%e6%8c%81%e7%ba%8c%e7%96%b2%e5%bc%b1%ef%bc%8c%e9%87%91%e7%ae%a1%e5%b1%80%e4%b8%8b%e5%8d%88%e7%ac%ac%e4%b8%83%e5%ba%a6%e5%85%a5%e5%b8%82%e8%b2%b7%e5%85%a533.76%e5%84%84%e6%b8%af%e5%85%83%e3%80%82%e6%b8%af%e8%82%a1%e4%bb%8a%e6%97%a5%e5%8f%8d%e8%a6%86%e4%b8%8b%e8%b7%8c%e3%80%82%e7%be%8e%e5%9c%8b%e5%95%86%e5%8b%99%e9%83%a8%e5%ae%a3%e5%b8%83%e7%a6%81%e6%ad%a2%e7%be%8e%e5%9c%8b%e4%bc%81%e6%a5%ad%ef%bc%8c...%0d%0a%0d%0ahttp%3a%2f%2fwww.aastocks.com%2ftc%2fstocks%2fnews%2faafn-news%2fNOW.868068%2f2&amp;pic=http%3a%2f%2fplib.aastocks.com%2faafnnews%2fimage%2fmedialib%2f20180320103539160_m.jpg')"></div> <div class="float_r news-icon-map news-icon-facebook pt" style="margin:2px 16px 0px 0px;" onclick="javascript:faceBookClick('http://www.aastocks.com/tc/stocks/news/aafn-news/NOW.868068/2')"></div> <div class="clear"></div> </div> </div> </div> </div> </div> </div> </div> <div id="subNewsLatest_withSkinner" style="margin-top: 10px;"> <div class="content comm-panel2"> <div class="ns1 white"> <div class="bg"></div> <div class="title">今日熱點</div> <a href="javascript:gotoOpenerUrl('/tc/stocks/news/aafn/popular-news')" class="more-lnk"></a> </div> <table class="ns1" style="width:100%;"> <tbody> <tr> <td class="tb-latest-news"> <div class="itemHotNews "> <div> <div class="ratio-circle r10"> <div class="num blue"><span class="tooltips-target">1</span></div> <div class="pct blue"><span class="tooltips-target">9%</span></div> </div> <div class="news-headline"> <a href="javascript:gotoOpenerUrl('/tc/stocks/news/aafn-content/NOW.868072/popular-news')" title="人行：降準置換MLF釋放4,000億  穩健中性貨幣政策取向保持不變">
人行：降準置換MLF釋放4,000億  穩健中性貨幣政策取向保持不變</a></div> <div class="clear"></div> </div> </div> <div class="itemHotNews "> <div> <div class="ratio-circle r5"> <div class="num blue"><span class="tooltips-target">2</span></div> <div class="pct blue"><span class="tooltips-target">6%</span></div> </div> <div class="news-headline"> <a href="javascript:gotoOpenerUrl('/tc/stocks/news/aafn-content/NOW.868068/popular-news')" title="《即日市評》中美貿易戰升溫恆指再跌 手機設備股捱沽">
《即日市評》中美貿易戰升溫恆指再跌 手機設備股捱沽</a></div> <div class="clear"></div> </div> </div> <div class="itemHotNews last"> <div> <div class="ratio-circle r5"> <div class="num blue"><span class="tooltips-target">3</span></div> <div class="pct blue"><span class="tooltips-target">6%</span></div> </div> <div class="news-headline"> <a href="javascript:gotoOpenerUrl('/tc/stocks/news/aafn-content/NOW.868013/popular-news')" title="「新興市場之父」指美股待跌 面臨三成調整">
「新興市場之父」指美股待跌 面臨三成調整</a></div> <div class="clear"></div> </div> </div>  </td> </tr> </tbody> </table> </div> </div> <div id="subNewsRelated_withSkinner" style="margin-top: 30px;"> <div class="content"> <div class="ns1 white"> <div class="bg"></div> <div class="title font19 lblRelatedNewsTitle">即市新聞</div> <a class="more-lnk lnkRelatedNewsTitle" href="javascript:gotoOpenerUrl('/tc/stocks/news/aafn/latest-news');"></a> </div> <table class="ns1" style="width:100%;"> <tbody class="tb-related-news"><tr><td class="npad newsBoxList"><div class="newsBox"><a href='javascript:gotoOpenerUrl("/tc/stocks/news/aafn-content/NOW.868072/latest-news")' title="人行：降準置換MLF釋放4,000億  穩健中性貨幣政策取向保持不變"><div class="news-image"><img src="http://plib.aastocks.com/aafnnews/image/medialib/20180206163434869_s.jpg" style="width:100%"></div><div class="news-content"><div class="news-content-mask"><div class="news-content-text">人行：降準置換MLF釋放4,000億  穩健中性貨幣政策取向保持不變</div></div></div></a></div><div class="newsBox newsBoxLeftMargin"><a href='javascript:gotoOpenerUrl("/tc/stocks/news/aafn-content/NOW.868071/latest-news")' title="《新股表現》HKE(01726.HK)暗盤收0.7元  高上市價27%每手賺750元"><div class="news-image"><img src="http://plib.aastocks.com/aafnnews/image/medialib/20180115141815344_s.jpg" style="width:100%"></div><div class="news-content"><div class="news-content-mask"><div class="news-content-text">《新股表現》HKE(01726.HK)暗盤收0.7元  高上市價27%每手賺750元</div></div></div></a></div><div class="newsBox newsBoxLeftMargin"><a href='javascript:gotoOpenerUrl("/tc/stocks/news/aafn-content/NOW.868070/latest-news")' title="人行下調部分金融機構存準金率以置換中期借貸便利"><div class="news-image"><img src="http://plib.aastocks.com/aafnnews/image/medialib/20180308154957144_s.jpg" style="width:100%"></div><div class="news-content"><div class="news-content-mask"><div class="news-content-text">人行下調部分金融機構存準金率以置換中期借貸便利</div></div></div></a></div><div class="clear"></div></td></tr></tbody> </table> </div> </div> </div>"""
    htmlpage = HtmlPage(url=url, body=body)
    for index, i in enumerate(htmlpage.parsed_body):
        try:
            print index, i.tag, i.tag_type, htmlpage.fragment_data(i)
        except Exception:
            print index
    print '################'
    print find_context_index(htmlpage=htmlpage, text_compile=u'^港匯持續疲弱，金管局下午第七度入市買入33\.76億港元。港股今日反覆下跌。美國商務部宣布禁止美國企業，向內地電信設備廠商中興通訊\(00763\.HK\)$')
    print full_div_context_index(htmlpage=htmlpage, text_compile=u'^港匯持續疲弱，金管局下午第七度入市買入33\.76億港元。港股今日反覆下跌。美國商務部宣布禁止美國企業，向內地電信設備廠商中興通訊\(00763\.HK\)$')
    # print full_div_context_index(htmlpage=htmlpage, text_compile=u'^黑塑料袋儿是“拿货人”的标配$')

    # print find_context_index(htmlpage=htmlpage, text_compile=u'^港股今日(17日)全日跌252點或0.8%，報30,062點，全日成.*萬人幣勢頭。$')
